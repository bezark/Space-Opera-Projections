[gd_scene load_steps=7 format=3 uid="uid://bgluraosox2oe"]

[ext_resource type="Script" uid="uid://bcshhps4gpxlp" path="res://Assets/1Toys/blackhole.gd" id="1_nu81i"]
[ext_resource type="Script" uid="uid://badidsgy73djm" path="res://Assets/1Toys/hole_controls.gd" id="2_put6h"]

[sub_resource type="Shader" id="Shader_j4skb"]
code = "shader_type spatial;
render_mode unshaded;

uniform sampler2D screen_tex : hint_screen_texture;
uniform sampler2D depth_tex : hint_depth_texture;
uniform float scale;

bool hit_sphere(vec3 ray_origin, vec3 ray_dir, vec3 sphere_origin, float radius) {
	vec3 oc = ray_origin - sphere_origin;
	float a = dot(ray_dir, ray_dir);
	float b = 2.0 * dot(ray_dir, oc);
	float c = dot(oc, oc) - (radius * radius);
	float disc = (b * b) - 4.0 * a * c;
	return disc > 0.0;
}

vec3 get_world_position_from_uv(vec2 uv, float depth, mat4 inv_proj_m, mat4 inv_view_m) {
	vec4 ndc = vec4((uv * 2.0) - 1.0, depth, 1.0);
	vec4 view_p = inv_proj_m * ndc;
	view_p.xyz /= view_p.w;
	view_p = (inv_view_m * vec4(view_p.xyz, 1.0));
	return view_p.xyz;
}

vec2 get_uv_from_world_position(vec3 position_w, mat4 proj_m, mat4 view_m) {
	vec3 position_v = (view_m * vec4(position_w, 1.0)).xyz;
	vec4 position_cs = proj_m * vec4(position_v.xyz, 1.0);
	vec2 ndc = position_cs.xy / position_cs.w;
	return ndc.xy * 0.5 + 0.5;
}

float fresnel(float amount, vec3 normal, vec3 view) {
	return pow((1.0 - clamp(dot(normalize(normal), normalize(view)), 0.0, 1.0 )), amount);
}

void fragment() {
	float depth = texture(depth_tex, SCREEN_UV).x;
	vec3 frag_p = get_world_position_from_uv(SCREEN_UV, depth, INV_PROJECTION_MATRIX, INV_VIEW_MATRIX);
	vec3 ray_dir = normalize(frag_p - CAMERA_POSITION_WORLD);

	bool hit = hit_sphere(CAMERA_POSITION_WORLD, ray_dir, NODE_POSITION_WORLD, scale * .3);

	vec4 screen_color = texture(screen_tex, SCREEN_UV);
	vec3 color;
	if (hit) {
		color = vec3(0.0);
	}
	else {
		vec2 bh_p = get_uv_from_world_position(NODE_POSITION_WORLD, PROJECTION_MATRIX, VIEW_MATRIX);
		vec2 dis_dir = normalize(bh_p - SCREEN_UV) * 0.5;
		float f =  1.0 - fresnel(0.5, NORMAL, VIEW);

		float fov = atan(-1.0 / PROJECTION_MATRIX[1][1] * 2.0);
		float dist = distance(CAMERA_POSITION_WORLD, NODE_POSITION_WORLD);
		float s = (2.0 * dist * tan(fov * 0.5)) / scale;

		vec2 uv = SCREEN_UV + (dis_dir * (f / s));
		screen_color = texture(screen_tex, uv);
		color = vec3(screen_color.r, screen_color.g, screen_color.b);

	}
	ALBEDO = color;
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_d1v7t"]
render_priority = 0
shader = SubResource("Shader_j4skb")
shader_parameter/scale = 500.0

[sub_resource type="SphereMesh" id="SphereMesh_smirv"]
material = SubResource("ShaderMaterial_d1v7t")
flip_faces = true
radius = 250.0
height = 500.0

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_dee4i"]
emission_enabled = true
emission = Color(0.940695, 0.635263, 0.338721, 1)
emission_energy_multiplier = 3.0

[node name="Blackhole" type="MeshInstance3D"]
transform = Transform3D(1, 0, 0, 0, 0.999986, 0.00532323, 0, -0.00532323, 0.999986, 0, 0, 0)
mesh = SubResource("SphereMesh_smirv")
script = ExtResource("1_nu81i")

[node name="Disk" type="CSGTorus3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 0.1, 0, 0, 0, 1, 0, 0, 0)
inner_radius = 250.0
outer_radius = 300.0
sides = 64
ring_sides = 64
material = SubResource("StandardMaterial3D_dee4i")

[node name="OmniLight3D" type="OmniLight3D" parent="."]
light_energy = 100.0
omni_range = 1000.0

[node name="HoleControls" type="FlowContainer" parent="." groups=["system_control"]]
offset_right = 40.0
offset_bottom = 40.0
script = ExtResource("2_put6h")

[node name="Button" type="Button" parent="HoleControls"]
layout_mode = 2
toggle_mode = true
text = "Blackhole"

[node name="Controls" type="FlowContainer" parent="HoleControls"]
visible = false
layout_mode = 2

[node name="Scale" type="VSlider" parent="HoleControls/Controls"]
custom_minimum_size = Vector2(0, 400)
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 3
max_value = 500.0
step = 0.1

[node name="ColorPickerButton" type="ColorPickerButton" parent="HoleControls/Controls"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 3
color = Color(0.739975, 0.417669, 0.0813718, 1)

[connection signal="toggled" from="HoleControls/Button" to="HoleControls" method="_on_button_toggled"]
[connection signal="value_changed" from="HoleControls/Controls/Scale" to="." method="_on_scale_value_changed"]
